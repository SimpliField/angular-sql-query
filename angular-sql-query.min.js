"use strict";!function(e){function t(t,u){function c(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.indexed_fields||[];return this.options=n,this.backUpName=e,this.helpers={indexed_fields:r},this.backUpDB=function(){return t()},this}return c.prototype.getBackUp=function(e){if(!e)throw new Error({err:"We need an id"});var n=this,c=r(n.backUpName,{id:e});return this.execute(c.query,c.params).then(function(e){return e.rows.length?N(e,0):u.reject({message:"Not Found",status:404})}).catch(function(e){throw t.error("[Backup] Get",n.backUpName,":",e.message),e})},c.prototype.listBackUp=function(e){var n=this,u=r(n.backUpName,{},e);return this.execute(u.query).then(v).catch(function(e){throw t.error("[Backup] List",n.backUpName,":",e.message),e})},c.prototype.queryBackUp=function(r,c){function o(e,t,n){return B(n,x).map(function(n){return{query:"INSERT INTO "+e+" "+s(n,t),params:n}})}var a=this,i=a.helpers.indexed_fields,f=k(r||{}),p=function(t){return Object.keys(t).reduce(function(n,r){var u=t[r];return e.isArray(u)&&O<u.length?n.ext[r]=u:n.self[r]=u,n},{self:{},ext:{}})}(E(i,f)),h=function(e,t){var n="tmp_"+a.backUpName+"_";return Object.keys(t.ext||{}).map(function(e){var r=n+e,u="DROP TABLE IF EXISTS "+r,c="CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)",a=o(r,"value",t.ext[e]);return[{query:u},{query:c}].concat(a)})}(0,p).reduce(function(e,t){return e.concat(t)},[]);return(h.length?a.batch(h):u.when()).then(function(){var e=n(a.backUpName,p,c);return a.execute(e.query,e.params).then(function(e){return y(v(e),b(i,f))})}).catch(function(e){throw t.error("[Backup] Query",a.backUpName,":",e.message),e})},c.prototype.saveBackUp=function(e,n){var r=this,u=r.helpers.indexed_fields,c=this.backUpName,o=f([n],u,c);return this.execute(o.query,o.params).then(function(){return n}).catch(function(e){throw t.error("[Backup] Save",r.backUpName,":",e.message),e})},c.prototype.updateBackUp=function(e){var n=this,r=n.backUpName,u=n.helpers.indexed_fields,c=h(e,u,r);return this.execute(c.query,c.params).then(function(){return e}).catch(function(e){throw t.error("[Backup] Update",r,":",e.message),e})},c.prototype.removeBackUp=function(e){var n=this,r=m({id:e},n.backUpName);return this.execute(r.query,r.params).catch(function(e){throw t.error("[Backup] Remove",n.backUpName,":",e.message),e})},c.prototype.removeQueryBackUp=function(e){var n=this,r=m(e,n.backUpName);return this.execute(r.query,r.params).catch(function(e){throw t.error("[Backup] Remove",n.backUpName,":",e.message),e})},c.prototype.bulkDocsBackUp=function(e){var n=this,r=n.helpers.indexed_fields,c=n.backUpName,o=[],a=e.filter(function(e){return e._deleted}).map(function(e){return e.id}),i=e.filter(function(e){return!e._deleted});return a.length&&o.push(m({id:a},c)),i.length&&o.push(f(i,r,c)),o.length?u.all(o.map(function(e){return n.execute(e.query,e.params)})).catch(function(e){throw t.error("[Backup] Bulk",n.backUpName,":",e.message),e}):u.when()},c.prototype.execute=function(e,t){var n=u.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,t,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})})}),n.promise},c.prototype.batch=function(e){function t(t){var n=u.defer();return t.transaction(function(t){e.forEach(function(e){t.executeSql(e.query,e.params||[])})},n.reject,n.resolve),n.promise}var n=u.defer();return this.backUpDB().then(function(r){return r.sqlBatch?r.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return n.resolve(e)},function(e){return n.reject(e)}):t(r).then(n.resolve).catch(n.reject)}),n.promise},c}function n(t,n,r){function u(t){return Object.keys(t).map(function(t){var r=n.self[t];return t+(e.isArray(r)?" IN ("+g(r)+")":"=?")})}function c(e){return Object.keys(e).map(function(e){return e+" IN (SELECT value FROM "+("tmp_"+t+"_"+e)+")"})}return{query:function(e){var n="SELECT * FROM "+t,o=[].concat(u(e.self),c(e.ext));return i(n+(o.length?" WHERE ":"")+o.join(" AND "),r)+";"}(n),params:Object.keys(n.self).reduce(function(e,t){return e.concat(n.self[t])},[])}}function r(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{query:i(a("SELECT * FROM "+e,t),n),params:c(t)}}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(t){return o(t,e[t])}).join(" AND ")}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(t){return e[t]}).reduce(function(e,t){return e.concat(t)},[])}function o(e,t){return e+(Array.isArray(t)?" IN ("+g(t)+")":"=?")}function a(e,t){var n=u(t);return n?e+" WHERE "+n:e}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.limit?" LIMIT "+t.limit:"";return t.offset&&(n+=" OFFSET "+t.offset),e+n}function f(e,t,n){var r="INSERT OR REPLACE INTO "+n,u=["id","payload"].concat(t),c=g(u);return{query:r+" "+("("+u.join(", ")+")")+" "+(1<e.length?s(e,u):"VALUES ("+c+")"),params:e.map(function(e){return[e.id].concat(l(e,t))}).reduce(function(e,t){return e.concat(t)},[])}}function s(e,t){var n=[].concat(t),r=g(n),u=p(n);return e.map(function(e,t){return 0===t?u:"UNION ALL SELECT "+r}).join(" ")}function p(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function h(e,t,n){var r="UPDATE "+n,u=["payload"].concat(t),c=l(e,t);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function m(e,t){return{query:a("DELETE FROM "+t,e),params:c(e)}}function l(t,n){var r=d(t,n);return[e.toJson(t)].concat(r)}function d(t,n){return n.map(function(n){var r=q(t[n]);return e.isDefined(r)?r:null})}function y(t,n){return Object.keys(n).length?t.filter(function(t){return Object.keys(n||{}).every(function(r){var u=t[r],c=n[r];return e.isArray(c)?c.some(function(e){return e===u}):c===u})}):t}function v(e){var t=[],n=0;for(n=0;n<e.rows.length;n++)t[n]=N(e,n);return t}function k(e){return Object.keys(e).reduce(function(t,n){var r=q(e[n]);return t[n]=r,t},{})}function b(e,t){return Object.keys(t).reduce(function(n,r){return U(r,e)||(n[r]=t[r]),n},{})}function E(e,t){return Object.keys(t).reduce(function(n,r){return U(r,e)&&(n[r]=t[r]),n},{})}function U(e,t){return-1!==t.indexOf(e)||"id"===e}function N(t,n){return e.fromJson(t.rows.item(n).payload)}function g(e){return e.map(function(){return"?"}).join(",")}function q(e){return j(e)?e?1:0:e}function j(e){return"boolean"==typeof e}function B(e,t){for(var n=e.length,r=Math.ceil(n/t),u=[],c=0,o=0,a=0;c<r;c++)o=c*t,a=(c+1)*t,u.push(e.slice(o,a));return u}t.$inject=["$log","$q"];var O=100,x=300;e.module("sf.sqlQuery",[]).factory("SqlQueryService",t)}(window.angular);