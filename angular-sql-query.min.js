"use strict";!function(e){function n(n,u){function c(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.indexed_fields||[];return this.options=t,this.backUpName=e,this.helpers={indexed_fields:r},this.backUpDB=function(){return n()},this}return c.prototype.getBackUp=function(e){if(!e)throw new Error({err:"We need an id"});var t=this,c=r(t.backUpName,{id:e});return this.execute(c.query,c.params).then(function(e){return e.rows.length?N(e,0):u.reject({message:"Not Found",status:404})}).catch(function(e){throw n.error("[Backup] Get",t.backUpName,":",e.message),e})},c.prototype.listBackUp=function(e){var t=this,u=r(t.backUpName,{},e);return this.execute(u.query).then(k).catch(function(e){throw n.error("[Backup] List",t.backUpName,":",e.message),e})},c.prototype.queryBackUp=function(r,c,o){function a(e,n,t){return O(t,T).map(function(t){return{query:"INSERT INTO "+e+" "+p(t,n),params:t}})}var i=this,f=i.helpers.indexed_fields,s=E(r||{}),h=function(n){return Object.keys(n).reduce(function(t,r){var u=n[r];return e.isArray(u)&&x<u.length?t.ext[r]=u:t.self[r]=u,t},{self:{},ext:{}})}(U(f,s)),m=function(e,n){var t="tmp_"+i.backUpName+"_";return Object.keys(n.ext||{}).map(function(e){var r=t+e,u="DROP TABLE IF EXISTS "+r,c="CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)",o=a(r,"value",n.ext[e]);return[{query:u},{query:c}].concat(o)})}(0,h).reduce(function(e,n){return e.concat(n)},[]);return(m.length?i.batch(m):u.when()).then(function(){var e=t(i.backUpName,h,c,o);return i.execute(e.query,e.params).then(function(e){return v(k(e),b(f,s))})}).catch(function(e){throw n.error("[Backup] Query",i.backUpName,":",e.message),e})},c.prototype.saveBackUp=function(e,t){var r=this,u=r.helpers.indexed_fields,c=this.backUpName,o=s([t],u,c);return this.execute(o.query,o.params).then(function(){return t}).catch(function(e){throw n.error("[Backup] Save",r.backUpName,":",e.message),e})},c.prototype.updateBackUp=function(e){var t=this,r=t.backUpName,u=t.helpers.indexed_fields,c=m(e,u,r);return this.execute(c.query,c.params).then(function(){return e}).catch(function(e){throw n.error("[Backup] Update",r,":",e.message),e})},c.prototype.removeBackUp=function(e){var t=this,r=l({id:e},t.backUpName);return this.execute(r.query,r.params).catch(function(e){throw n.error("[Backup] Remove",t.backUpName,":",e.message),e})},c.prototype.removeQueryBackUp=function(e){var t=this,r=l(e,t.backUpName);return this.execute(r.query,r.params).catch(function(e){throw n.error("[Backup] Remove",t.backUpName,":",e.message),e})},c.prototype.bulkDocsBackUp=function(e){var t=this,r=t.helpers.indexed_fields,c=t.backUpName,o=[],a=e.filter(function(e){return e._deleted}).map(function(e){return e.id}),i=e.filter(function(e){return!e._deleted});return a.length&&o.push(l({id:a},c)),i.length&&o.push(s(i,r,c)),o.length?u.all(o.map(function(e){return t.execute(e.query,e.params)})).catch(function(e){throw n.error("[Backup] Bulk",t.backUpName,":",e.message),e}):u.when()},c.prototype.execute=function(e,n){var t=u.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,n,function(e,n){t.resolve(n)},function(e,n){t.reject(n)})})}),t.promise},c.prototype.batch=function(e){function n(n){var t=u.defer();return n.transaction(function(n){e.forEach(function(e){n.executeSql(e.query,e.params||[])})},t.reject,t.resolve),t.promise}var t=u.defer();return this.backUpDB().then(function(r){return r.sqlBatch?r.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return t.resolve(e)},function(e){return t.reject(e)}):n(r).then(t.resolve).catch(t.reject)}),t.promise},c}function t(n,t,r,u){function c(n){return Object.keys(n).map(function(n){var r=t.self[n];return n+(e.isArray(r)?" IN ("+j(r)+")":"=?")})}function o(e){return Object.keys(e).map(function(e){return e+" IN (SELECT value FROM "+("tmp_"+n+"_"+e)+")"})}return{query:function(e){var t="SELECT * FROM "+n,a=[].concat(c(e.self),o(e.ext));return f(i(t+(a.length?" WHERE ":"")+a.join(" AND "),u),r)+";"}(t),params:Object.keys(t.self).reduce(function(e,n){return e.concat(t.self[n])},[])}}function r(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{query:f(a("SELECT * FROM "+e,n),t),params:c(n)}}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return o(n,e[n])}).join(" AND ")}function c(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return e[n]}).reduce(function(e,n){return e.concat(n)},[])}function o(e,n){return e+(Array.isArray(n)?" IN ("+j(n)+")":"=?")}function a(e,n){var t=u(n);return t?e+" WHERE "+t:e}function i(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return 0===n.length?e:e+(" ORDER BY "+n.map(function(e){return e.key+(e.desc?" DESC":"")}).join(","))}function f(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=n.limit?" LIMIT "+n.limit:"";return n.offset&&(t+=" OFFSET "+n.offset),e+t}function s(e,n,t){var r="INSERT OR REPLACE INTO "+t,u=["id","payload"].concat(n),c=j(u);return{query:r+" "+("("+u.join(", ")+")")+" "+(1<e.length?p(e,u):"VALUES ("+c+")"),params:e.map(function(e){return[e.id].concat(d(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function p(e,n){var t=[].concat(n),r=j(t),u=h(t);return e.map(function(e,n){return 0===n?u:"UNION ALL SELECT "+r}).join(" ")}function h(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function m(e,n,t){var r="UPDATE "+t,u=["payload"].concat(n),c=d(e,n);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function l(e,n){return{query:a("DELETE FROM "+n,e),params:c(e)}}function d(n,t){var r=y(n,t);return[e.toJson(n)].concat(r)}function y(n,t){return t.map(function(t){var r=q(n[t]);return e.isDefined(r)?r:null})}function v(n,t){return Object.keys(t).length?n.filter(function(n){return Object.keys(t||{}).every(function(r){var u=n[r],c=t[r];return e.isArray(c)?c.some(function(e){return e===u}):c===u})}):n}function k(e){var n=[],t=0;for(t=0;t<e.rows.length;t++)n[t]=N(e,t);return n}function E(e){return Object.keys(e).reduce(function(n,t){var r=q(e[t]);return n[t]=r,n},{})}function b(e,n){return Object.keys(n).reduce(function(t,r){return g(r,e)||(t[r]=n[r]),t},{})}function U(e,n){return Object.keys(n).reduce(function(t,r){return g(r,e)&&(t[r]=n[r]),t},{})}function g(e,n){return-1!==n.indexOf(e)||"id"===e}function N(n,t){return e.fromJson(n.rows.item(t).payload)}function j(e){return e.map(function(){return"?"}).join(",")}function q(e){return B(e)?e?1:0:e}function B(e){return"boolean"==typeof e}function O(e,n){for(var t=e.length,r=Math.ceil(t/n),u=[],c=0,o=0,a=0;c<r;c++)o=c*n,a=(c+1)*n,u.push(e.slice(o,a));return u}n.$inject=["$log","$q"];var x=100,T=300;e.module("sf.sqlQuery",[]).factory("SqlQueryService",n)}(window.angular);