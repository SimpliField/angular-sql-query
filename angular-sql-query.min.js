"use strict";!function(e){function n(n,u){function c(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.indexed_fields||[];return this.options=t,this.backUpName=e,this.helpers={indexed_fields:r},this.backUpDB=function(){return n()},this}return c.prototype.getBackUp=function(e){if(!e)throw new Error("You need to provide an id");var t=this,c=r(t.backUpName,{id:e});return this.execute(c.query,c.params).then(function(e){return e.rows.length?N(e,0):u.reject({message:"Not Found",status:404})}).catch(function(e){throw n.error("[Backup] Get",t.backUpName,":",e.message),e})},c.prototype.listBackUp=function(e){var t=this,u=r(t.backUpName,{},e);return this.execute(u.query).then(b).catch(function(e){throw n.error("[Backup] List",t.backUpName,":",e.message),e})},c.prototype.queryBackUp=function(){function r(e,n,t){return B(t,w).map(function(t){return{query:"INSERT INTO "+e+" "+l(t,n),params:t}})}var c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=this,f=a.helpers.indexed_fields,s=g(c),p=function(n){var t=function(n){return e.isArray(n)&&R<n.length};return Object.keys(n).reduce(function(e,r){var u=n[r];return e[t(u)?"ext":"self"][r]=u,e},{self:{},ext:{}})}(j(f,s)),h=function(e,n){return Object.keys(n.ext).map(function(t){var u="tmp_"+e+"_"+t,c="DROP TABLE IF EXISTS "+u,o="CREATE TABLE IF NOT EXISTS "+u+" (value TEXT)",i=r(u,"value",n.ext[t]);return[{query:c},{query:o}].concat(i)})}(a.backUpName,p).reduce(function(e,n){return e.concat(n)},[]);return(h.length?a.batch(h):u.when()).then(function(){var e=t(a.backUpName,p,o,i);return a.execute(e.query,e.params).then(function(e){return E(b(e),U(f,s))})}).catch(function(e){throw n.error("[Backup] Query",a.backUpName,":",e.message),e})},c.prototype.saveBackUp=function(e,t){var r=this,u=r.helpers.indexed_fields,c=this.backUpName,o=h([t],u,c);return this.execute(o.query,o.params).then(function(){return t}).catch(function(e){throw n.error("[Backup] Save",r.backUpName,":",e.message),e})},c.prototype.updateBackUp=function(e){var t=this,r=t.backUpName,u=t.helpers.indexed_fields,c=d(e,u,r);return this.execute(c.query,c.params).then(function(){return e}).catch(function(e){throw n.error("[Backup] Update",r,":",e.message),e})},c.prototype.removeBackUp=function(e){var t=this,r=v({id:e},t.backUpName);return this.execute(r.query,r.params).catch(function(e){throw n.error("[Backup] Remove",t.backUpName,":",e.message),e})},c.prototype.removeQueryBackUp=function(e){var t=this,r=v(e,t.backUpName);return this.execute(r.query,r.params).catch(function(e){throw n.error("[Backup] Remove",t.backUpName,":",e.message),e})},c.prototype.bulkDocsBackUp=function(e){var t=this,r=t.helpers.indexed_fields,c=t.backUpName,o=[],i=e.filter(function(e){return e._deleted}).map(function(e){return e.id}),a=e.filter(function(e){return!e._deleted});return i.length&&o.push(v({id:i},c)),a.length&&o.push(h(a,r,c)),o.length?u.all(o.map(function(e){return t.execute(e.query,e.params)})).catch(function(e){throw n.error("[Backup] Bulk",t.backUpName,":",e.message),e}):u.when()},c.prototype.execute=function(e,n){var t=u.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,n,function(e,n){t.resolve(n)},function(e,n){return t.reject(n),!1})})}),t.promise},c.prototype.batch=function(e){function n(n){var t=u.defer();return n.transaction(function(n){e.forEach(function(e){n.executeSql(e.query,e.params||[])})},t.reject,t.resolve),t.promise}var t=u.defer();return this.backUpDB().then(function(r){return r.sqlBatch?r.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return t.resolve(e)},function(e){return t.reject(e)}):n(r).then(t.resolve).catch(t.reject)}),t.promise},c}function t(e,n,t,r){function u(e){return Object.keys(e).map(function(n){return a(n,e[n])})}function c(n){return Object.keys(n).map(function(n){return n+" IN (SELECT value FROM "+("tmp_"+e+"_"+n)+")"})}return{query:function(n){var o="SELECT * FROM "+e,i=[].concat(u(n.self),c(n.ext));return p(s(o+(i.length?" WHERE ":"")+i.join(" AND "),r),t)+";"}(n),params:Object.keys(n.self).reduce(function(e,t){return e.concat(S(n.self[t]))},[])}}function r(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{query:p(f("SELECT * FROM "+e,n),t),params:i(n)}}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return o(Object.keys(e).map(function(n){return a(n,e[n])}))}function c(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map(function(e){return e.key+(e.desc?" DESC":"")}).join(",")}function o(e){return e.join(" AND ")}function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return S(e[n])}).reduce(function(e,n){return e.concat(n)},[])}function a(e,n){return Array.isArray(n)?e+" IN ("+O(n)+")":T(n)?e+" LIKE ?":e+"=?"}function f(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return 0<Object.keys(n).length?e+" WHERE "+u(n):e}function s(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return 0<n.length?e+" ORDER BY "+c(n):e}function p(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=e;return n.limit&&(t+=" LIMIT "+n.limit),n.offset&&(t+=" OFFSET "+n.offset),t}function h(e,n,t){var r="INSERT OR REPLACE INTO "+t,u=["id","payload"].concat(n);return{query:r+" "+("("+u.join(", ")+")")+" "+(1<e.length?l(e,u):"VALUES ("+O(u)+")"),params:e.map(function(e){return[e.id].concat(y(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function l(e,n){var t=[].concat(n),r=m(t);return e.map(function(e,n){return 0===n?r:"UNION ALL SELECT "+O(t)}).join(" ")}function m(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function d(e,n,t){var r="UPDATE "+t,u=["payload"].concat(n),c=y(e,n);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function v(e,n){return{query:f("DELETE FROM "+n,e),params:i(e)}}function y(n,t){var r=k(n,t);return[e.toJson(n)].concat(r)}function k(n,t){return t.map(function(t){var r=q(n[t]);return e.isDefined(r)?r:null})}function E(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.keys(t).length?n.filter(function(n){return Object.keys(t).every(function(r){var u=n[r],c=t[r];return e.isArray(c)?c.some(function(e){return e===u}):c===u})}):n}function b(e){var n=[],t=0;for(t=0;t<e.rows.length;t++)n[t]=N(e,t);return n}function g(e){return Object.keys(e).reduce(function(n,t){return n[t]=q(e[t]),n},{})}function U(e,n){var t=function(n){return-1!==e.indexOf(n)||"id"===n};return Object.keys(n).reduce(function(e,r){return t(r)||(e[r]=n[r]),e},{})}function j(e,n){var t=function(n){return-1!==e.indexOf(n)||"id"===n};return Object.keys(n).reduce(function(e,r){return t(r)&&(e[r]=n[r]),e},{})}function N(n,t){return e.fromJson(n.rows.item(t).payload)}function O(e){return e.map(function(){return"?"}).join(",")}function q(e){return x(e)?e?1:0:e}function x(e){return"boolean"==typeof e}function B(e,n){for(var t=e.length,r=Math.ceil(t/n),u=[],c=0,o=0,i=0;c<r;c++)o=c*n,i=(c+1)*n,u.push(e.slice(o,i));return u}function T(e){return"[object RegExp]"===Object.prototype.toString.call(e)}function S(e){return T(e)?"%"+e.source+"%":e}n.$inject=["$log","$q"];var R=100,w=300;e.module("sf.sqlQuery",[]).factory("SqlQueryService",n)}(window.angular);