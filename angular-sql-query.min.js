"use strict";!function(){function e(e,t){function u(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=r.indexed_fields||[];return this.options=r,this.backUpName=e,this.helpers={indexed_fields:t},this.backUpDB=function(){return n()},this}return u.prototype.getBackUp=function(n){if(!n)throw new Error({err:"We need an id"});var u=this,c=r(u.backUpName,{id:n});return this.execute(c.query,c.params).then(function(e){return e.rows.length?g(e,0):t.reject({message:"Not Found",status:404})}).catch(function(n){throw e.error("[Backup] Get",u.backUpName,":",n.message),n})},u.prototype.listBackUp=function(n){var t=this,u=r(t.backUpName,{},n);return this.execute(u.query).then(y).catch(function(n){throw e.error("[Backup] List",t.backUpName,":",n.message),n})},u.prototype.queryBackUp=function(r,u){function c(e,n,r){return j(r,O).map(function(r){return{query:"INSERT INTO "+e+" "+f(r,n),params:r}})}var a=this,o=a.helpers.indexed_fields,i=v(r||{}),s=function(e){return Object.keys(e).reduce(function(n,r){var t=e[r];return angular.isArray(t)&&B<t.length?n.ext[r]=t:n.self[r]=t,n},{self:{},ext:{}})}(b(o,i)),p=function(e,n){var r="tmp_"+a.backUpName+"_";return Object.keys(n.ext||{}).map(function(e){var t=r+e,u="DROP TABLE IF EXISTS "+t,a="CREATE TABLE IF NOT EXISTS "+t+" (value TEXT)",o=c(t,"value",n.ext[e]);return[{query:u},{query:a}].concat(o)})}(0,s).reduce(function(e,n){return e.concat(n)},[]);return(p.length?a.batch(p):t.when()).then(function(){var e=n(a.backUpName,s,u);return a.execute(e.query,e.params).then(function(e){return d(y(e),k(o,i))})}).catch(function(n){throw e.error("[Backup] Query",a.backUpName,":",n.message),n})},u.prototype.saveBackUp=function(n,r){var t=this,u=t.helpers.indexed_fields,c=this.backUpName,a=i([r],u,c);return this.execute(a.query,a.params).then(function(){return r}).catch(function(n){throw e.error("[Backup] Save",t.backUpName,":",n.message),n})},u.prototype.updateBackUp=function(n){var r=this,t=r.backUpName,u=r.helpers.indexed_fields,c=p(n,u,t);return this.execute(c.query,c.params).then(function(){return n}).catch(function(n){throw e.error("[Backup] Update",t,":",n.message),n})},u.prototype.removeBackUp=function(n){var r=this,t=h({id:n},r.backUpName);return this.execute(t.query,t.params).catch(function(n){throw e.error("[Backup] Remove",r.backUpName,":",n.message),n})},u.prototype.removeQueryBackUp=function(n){var r=this,t=h(n,r.backUpName);return this.execute(t.query,t.params).catch(function(n){throw e.error("[Backup] Remove",r.backUpName,":",n.message),n})},u.prototype.bulkDocsBackUp=function(n){var r=this,u=r.helpers.indexed_fields,c=r.backUpName,a=[],o=n.filter(function(e){return e._deleted}).map(function(e){return e.id}),f=n.filter(function(e){return!e._deleted});return o.length&&a.push(h({id:o},c)),f.length&&a.push(i(f,u,c)),a.length?t.all(a.map(function(e){return r.execute(e.query,e.params)})).catch(function(n){throw e.error("[Backup] Bulk",r.backUpName,":",n.message),n}):t.when()},u.prototype.execute=function(e,n){var r=t.defer();return this.backUpDB().then(function(t){t.transaction(function(t){t.executeSql(e,n,function(e,n){r.resolve(n)},function(e,n){r.reject(n)})})}),r.promise},u.prototype.batch=function(e){function n(n){var r=t.defer();return n.transaction(function(n){e.forEach(function(e){n.executeSql(e.query,e.params||[])})},r.reject,r.resolve),r.promise}var r=t.defer();return this.backUpDB().then(function(t){return t.sqlBatch?t.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return r.resolve(e)},function(e){return r.reject(e)}):n(t).then(r.resolve).catch(r.reject)}),r.promise},u}function n(e,n,r){function t(e){return Object.keys(e).map(function(e){var r=n.self[e];return e+(angular.isArray(r)?" IN ("+U(r)+")":"=?")})}function u(n){return Object.keys(n).map(function(n){return n+" IN (SELECT value FROM "+("tmp_"+e+"_"+n)+")"})}return{query:function(n){var c="SELECT * FROM "+e,a=[].concat(t(n.self),u(n.ext));return o(c+(a.length?" WHERE ":"")+a.join(" AND "),r)+";"}(n),params:Object.keys(n.self).reduce(function(e,r){return e.concat(n.self[r])},[])}}function r(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{query:o(a("SELECT * FROM "+e,n),r),params:u(n)}}function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return c(n,e[n])}).join(" AND ")}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return e[n]}).reduce(function(e,n){return e.concat(n)},[])}function c(e,n){return e+(Array.isArray(n)?" IN ("+U(n)+")":"=?")}function a(e,n){var r=t(n);return r?e+" WHERE "+r:e}function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.limit?" LIMIT "+n.limit:"";return n.offset&&(r+=" OFFSET "+n.offset),e+r}function i(e,n,r){var t="INSERT OR REPLACE INTO "+r,u=["id","payload"].concat(n),c=U(u);return{query:t+" "+("("+u.join(", ")+")")+" "+(1<e.length?f(e,u):"VALUES ("+c+")"),params:e.map(function(e){return[e.id].concat(l(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function f(e,n){var r=[].concat(n),t=U(r),u=s(r);return e.map(function(e,n){return 0===n?u:"UNION ALL SELECT "+t}).join(" ")}function s(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function p(e,n,r){var t="UPDATE "+r,u=["payload"].concat(n),c=l(e,n);return{query:t+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function h(e,n){return{query:a("DELETE FROM "+n,e),params:u(e)}}function l(e,n){var r=m(e,n);return[angular.toJson(e)].concat(r)}function m(e,n){return n.map(function(n){var r=N(e[n]);return angular.isDefined(r)?r:null})}function d(e,n){return Object.keys(n).length?e.filter(function(e){return Object.keys(n||{}).every(function(r){var t=e[r],u=n[r];return angular.isArray(u)?u.some(function(e){return e===t}):u===t})}):e}function y(e){var n=[],r=0;for(r=0;r<e.rows.length;r++)n[r]=g(e,r);return n}function v(e){return Object.keys(e).reduce(function(n,r){var t=N(e[r]);return n[r]=t,n},{})}function k(e,n){return Object.keys(n).reduce(function(r,t){return E(t,e)||(r[t]=n[t]),r},{})}function b(e,n){return Object.keys(n).reduce(function(r,t){return E(t,e)&&(r[t]=n[t]),r},{})}function E(e,n){return-1!==n.indexOf(e)||"id"===e}function g(e,n){return angular.fromJson(e.rows.item(n).payload)}function U(e){return e.map(function(){return"?"}).join(",")}function N(e){return q(e)?e?1:0:e}function q(e){return"boolean"==typeof e}function j(e,n){for(var r=e.length,t=Math.ceil(r/n),u=[],c=0,a=0,o=0;c<t;c++)a=c*n,o=(c+1)*n,u.push(e.slice(a,o));return u}e.$inject=["$log","$q"];var B=100,O=300;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();