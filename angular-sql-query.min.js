"use strict";!function(){function e(e,r){function u(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.indexed_fields||[];return this.options=t,this.backUpName=e,this.helpers={indexed_fields:r},this.backUpDB=function(){return n()},this}return u.prototype.getBackUp=function(n){if(!n)throw new Error({err:"We need an id"});var u=this,c=t(u.backUpName,{id:n});return this.execute(c.query,c.params).then(function(e){return e.rows.length?g(e,0):r.reject({message:"Not Found",status:404})}).catch(function(n){throw e.error("[Backup] Get",u.backUpName,":",n.message),n})},u.prototype.listBackUp=function(n){var r=this,u=t(r.backUpName,{},n);return this.execute(u.query).then(y).catch(function(n){throw e.error("[Backup] List",r.backUpName,":",n.message),n})},u.prototype.queryBackUp=function(t,u){function c(e,n,t){return j(t,O).map(function(t){return{query:"INSERT INTO "+e+" "+f(t,n),params:t}})}var a=this,o=a.helpers.indexed_fields,i=v(t||{}),s=function(e){return Object.keys(e).reduce(function(n,t){var r=e[t];return angular.isArray(r)&&B<r.length?n.ext[t]=r:n.self[t]=r,n},{self:{},ext:{}})}(b(o,i)),p=function(e,n){var t="tmp_"+a.backUpName+"_";return Object.keys(n.ext||{}).map(function(e){var r=t+e,u="DROP TABLE IF EXISTS "+r,a="CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)",o=c(r,"value",n.ext[e]);return[{query:u},{query:a}].concat(o)})}(0,s).reduce(function(e,n){return e.concat(n)},[]);return(p.length?a.batch(p):r.when()).then(function(){var e=n(a.backUpName,s,u);return a.execute(e.query,e.params).then(function(e){return d(y(e),k(o,i))})}).catch(function(n){throw e.error("[Backup] Query",a.backUpName,":",n.message),n})},u.prototype.saveBackUp=function(n,t){var r=this,u=r.helpers.indexed_fields,c=this.backUpName,a=i([t],u,c);return this.execute(a.query,a.params).then(function(){return t}).catch(function(n){throw e.error("[Backup] Save",r.backUpName,":",n.message),n})},u.prototype.updateBackUp=function(n){var t=this,r=t.backUpName,u=t.helpers.indexed_fields,c=p(n,u,r);return this.execute(c.query,c.params).then(function(){return n}).catch(function(n){throw e.error("[Backup] Update",r,":",n.message),n})},u.prototype.removeBackUp=function(n){var t=this,r=h({id:n},t.backUpName);return this.execute(r.query,r.params).catch(function(n){throw e.error("[Backup] Remove",t.backUpName,":",n.message),n})},u.prototype.removeQueryBackUp=function(n){var t=this,r=h(n,t.backUpName);return this.execute(r.query,r.params).catch(function(n){throw e.error("[Backup] Remove",t.backUpName,":",n.message),n})},u.prototype.bulkDocsBackUp=function(n){var t=this,u=t.helpers.indexed_fields,c=t.backUpName,a=[],o=n.filter(function(e){return e._deleted}).map(function(e){return e.id}),f=n.filter(function(e){return!e._deleted});return o.length&&a.push(h({id:o},c)),f.length&&a.push(i(f,u,c)),a.length?r.all(a.map(function(e){return t.execute(e.query,e.params)})).catch(function(n){throw e.error("[Backup] Bulk",t.backUpName,":",n.message),n}):r.when()},u.prototype.execute=function(e,n){var t=r.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,n,function(e,n){t.resolve(n)},function(e,n){t.reject(n)})})}),t.promise},u.prototype.batch=function(e){function n(n){var t=r.defer();return n.transaction(function(n){e.forEach(function(e){n.executeSql(e.query,e.params||[])})},t.reject,t.resolve),t.promise}var t=r.defer();return this.backUpDB().then(function(r){return r.sqlBatch?r.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return t.resolve(e)},function(e){return t.reject(e)}):n(r).then(t.resolve).catch(t.reject)}),t.promise},u}function n(e,n,t){function r(e){return Object.keys(e).map(function(e){var t=n.self[e];return e+(angular.isArray(t)?" IN ("+U(t)+")":"=?")})}function u(n){return Object.keys(n).map(function(n){return n+" IN (SELECT value FROM "+("tmp_"+e+"_"+n)+")"})}return{query:function(n){var c="SELECT * FROM "+e,a=[].concat(r(n.self),u(n.ext));return o(c+(a.length?" WHERE ":"")+a.join(" AND "),t)+";"}(n),params:Object.keys(n.self).reduce(function(e,t){return e.concat(n.self[t])},[])}}function t(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{query:o(a("SELECT * FROM "+e,n),t),params:u(n)}}function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return c(n,e[n])}).join(" AND ")}function u(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.keys(e).map(function(n){return e[n]}).reduce(function(e,n){return e.concat(n)},[])}function c(e,n){return e+(n.length?" IN ("+U(n)+")":"=?")}function a(e,n){var t=r(n);return t?e+" WHERE "+t:e}function o(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=n.limit?" LIMIT "+n.limit:"";return n.offset&&(t+=" OFFSET "+n.offset),e+t}function i(e,n,t){var r="INSERT OR REPLACE INTO "+t,u=["id","payload"].concat(n),c=U(u);return{query:r+" "+("("+u.join(", ")+")")+" "+(1<e.length?f(e,u):"VALUES ("+c+")"),params:e.map(function(e){return[e.id].concat(l(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function f(e,n){var t=[].concat(n),r=U(t),u=s(t);return e.map(function(e,n){return 0===n?u:"UNION ALL SELECT "+r}).join(" ")}function s(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function p(e,n,t){var r="UPDATE "+t,u=["payload"].concat(n),c=l(e,n);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function h(e,n){return{query:a("DELETE FROM "+n,e),params:u(e)}}function l(e,n){var t=m(e,n);return[angular.toJson(e)].concat(t)}function m(e,n){return n.map(function(n){var t=N(e[n]);return angular.isDefined(t)?t:null})}function d(e,n){return Object.keys(n).length?e.filter(function(e){return Object.keys(n||{}).every(function(t){var r=e[t],u=n[t];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function y(e){var n=[],t=0;for(t=0;t<e.rows.length;t++)n[t]=g(e,t);return n}function v(e){return Object.keys(e).reduce(function(n,t){var r=N(e[t]);return n[t]=r,n},{})}function k(e,n){return Object.keys(n).reduce(function(t,r){return E(r,e)||(t[r]=n[r]),t},{})}function b(e,n){return Object.keys(n).reduce(function(t,r){return E(r,e)&&(t[r]=n[r]),t},{})}function E(e,n){return-1!==n.indexOf(e)||"id"===e}function g(e,n){return angular.fromJson(e.rows.item(n).payload)}function U(e){return e.map(function(){return"?"}).join(",")}function N(e){return q(e)?e?1:0:e}function q(e){return"boolean"==typeof e}function j(e,n){for(var t=e.length,r=Math.ceil(t/n),u=[],c=0,a=0,o=0;c<r;c++)a=c*n,o=(c+1)*n,u.push(e.slice(a,o));return u}e.$inject=["$log","$q"];var B=100,O=300;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();