!function(){"use strict";function e(e,t,r){function n(e,t){var n,a,o;return this.options=t||{},n=this.options.indexed_fields||[],a=["id","payload"].concat(n),o="?,?"+n.reduce(function(e){return e+",?"},""),this.backUpName=e,this.helpers={fields:a,questionsMark:o},this.backUpDB=function(){return r.initTables()},this}function a(){var t=this,r="SELECT * FROM "+t.backUpName;return this.execute(r).then(d)["catch"](function(r){throw e.error("[Backup] List",t.backUpName,":",r.message),r})}function o(r){var n=this,a="SELECT * FROM "+n.backUpName+" WHERE id=?";return this.execute(a,[r]).then(function(e){return e.rows.length?angular.fromJson(e.rows.item(0).payload):t.reject({message:"Not Found",status:404})})["catch"](function(t){throw e.error("[Backup] Get",n.backUpName,":",t.message),t})}function u(t){var r,n=this,a={},o=n.options.indexed_fields||[],u=[],c=t||{},i=Object.keys(c||{}).filter(function(e){var t=-1!==o.indexOf(e),r=c[e];return c[e]="boolean"==typeof r?r?1:0:r,t||(a[e]=c[e]),t}),s=i.map(function(e){var t=c[e],r="";return angular.isArray(t)?r=e+" IN ("+t.map(function(e){return u.push(e),"?"}).join(",")+")":(u.push(t),r=e+"=?"),r}).join(" AND ");return i.length&&(s=" WHERE "+s),r="SELECT * FROM "+n.backUpName+s,this.execute(r,u).then(function(e){var t=d(e);return k(t,a)})["catch"](function(t){throw e.error("[Backup] Query",n.backUpName,":",t.message),t})}function c(t,r){var n=this,a=m.call(n,t,r),o=l.call(n,!0);return this.execute(o,a)["catch"](function(t){throw e.error("[Backup] Save",n.backUpName,":",t.message),t})}function i(t){var r=this,n=m.call(r,t.id,t,!0),a=r.helpers.fields.slice(1),o=a.map(function(e){return e+"=?"}).join(", "),u="UPDATE "+r.backUpName+" SET "+o+" WHERE id=?";return this.execute(u,n)["catch"](function(t){throw e.error("[Backup] Update",r.backUpName,":",t.message),t})}function s(t){var r=this,n=f.call(r);return this.execute(n,[t])["catch"](function(t){throw e.error("[Backup] Remove",r.backUpName,":",t.message),t})}function p(r){var n=this,a=[],o=[],u=[];return r.forEach(function(e){var t=e._deleted;t?u.push(e.id):o.push(m.call(n,e.id,e))}),u.length&&a.push({query:f.call(this,u.length),params:u}),o.length&&a.push({query:l.call(n,!0,o.length),params:o.reduce(function(e,t){return e.concat(t)},[])}),a.length?t.all(a.map(function(e){return n.execute(e.query,e.params)}))["catch"](function(t){throw e.error("[Backup] Bulk",n.backUpName,":",t.message),t}):t.when()}function h(e,t){return this.backUpDB().then(function(){return r.execute(e,t)})}function f(e){var t="DELETE FROM "+this.backUpName+" WHERE id",r="",n=[],a=0;if(e=e||1,e>1){for(a=0;e>a;a++)n.push("?");r=" IN ("+n.join(",")+")"}else r="=?";return t+r}function l(e,t){function r(){var e=[];for(s=0;t>s;s++)e.push(0===s?"SELECT "+u.map(n).join(", "):"UNION ALL SELECT "+c);return e.join(" ")}function n(e){return"? as "+e}var a="INSERT "+(e?"OR REPLACE ":"")+"INTO",o="",u=this.helpers.fields,c=this.helpers.questionsMark,i="("+u.join(", ")+")",s=0;return t=t||1,o=t>1?r(u,c):o="VALUES ("+c+")",[a,this.backUpName,i,o].join(" ")}function m(e,t,r){var n=this.options.indexed_fields||[],a=n.map(function(e){var r=t[e];return"boolean"==typeof r?r?1:0:r}),o=[angular.toJson(t)].concat(a);return o[r?"push":"unshift"](e),o}function k(e,t){return e.filter(function(e){return Object.keys(t||{}).every(function(r){var n=e[r],a=t[r];return angular.isArray(a)?a.some(function(e){return e===n}):a===n})})}function d(e){var t=[],r=0;for(r=0;r<e.rows.length;r++)t[r]=angular.fromJson(e.rows.item(r).payload);return t}return n.prototype.getBackUp=o,n.prototype.listBackUp=a,n.prototype.queryBackUp=u,n.prototype.saveBackUp=c,n.prototype.updateBackUp=i,n.prototype.removeBackUp=s,n.prototype.bulkDocsBackUp=p,n.prototype.execute=h,n}angular.module("sf.sqlQuery",["sf.sqlStorage"]).factory("SqlQueryService",e),e.$inject=["$log","$q","sqlStorageService"]}();