!function(){"use strict";function e(e,t){function n(e,t,n){function r(){return t()}var a,o,u;return this.options=n||{},a=this.options.indexed_fields||[],o=["id","payload"].concat(a),u="?,?"+a.reduce(function(e){return e+",?"},""),this.backUpName=e,this.helpers={fields:o,questionsMark:u},this.backUpDB=r,this}function r(){var t=this,n="SELECT * FROM "+t.backUpName;return this.execute(n).then(k)["catch"](function(n){throw e.error("[Backup] List",t.backUpName,":",n.message),n})}function a(n){var r=this,a="SELECT * FROM "+r.backUpName+" WHERE id=?";return this.execute(a,[n]).then(function(e){return e.rows.length?angular.fromJson(e.rows.item(0).payload):t.reject({message:"Not Found",status:404})})["catch"](function(t){throw e.error("[Backup] Get",r.backUpName,":",t.message),t})}function o(t){var n,r=this,a={},o=r.options.indexed_fields||[],u=[],c=t||{},i=Object.keys(c||{}).filter(function(e){var t=-1!==o.indexOf(e),n=c[e];return c[e]="boolean"==typeof n?n?1:0:n,t||(a[e]=c[e]),t}),s=i.map(function(e){var t=c[e],n="";return angular.isArray(t)?n=e+" IN ("+t.map(function(e){return u.push(e),"?"}).join(",")+")":(u.push(t),n=e+"=?"),n}).join(" AND ");return i.length&&(s=" WHERE "+s),n="SELECT * FROM "+r.backUpName+s,this.execute(n,u).then(function(e){var t=k(e);return m(t,a)})["catch"](function(t){throw e.error("[Backup] Query",r.backUpName,":",t.message),t})}function u(t,n){var r=this,a=l.call(r,t,n),o=f.call(r,!0);return this.execute(o,a).then(function(){return n})["catch"](function(t){throw e.error("[Backup] Save",r.backUpName,":",t.message),t})}function c(t){var n=this,r=l.call(n,t.id,t,!0),a=n.helpers.fields.slice(1),o=a.map(function(e){return e+"=?"}).join(", "),u="UPDATE "+n.backUpName+" SET "+o+" WHERE id=?";return this.execute(u,r).then(function(){return t})["catch"](function(t){throw e.error("[Backup] Update",n.backUpName,":",t.message),t})}function i(t){var n=this,r=h.call(n);return this.execute(r,[t])["catch"](function(t){throw e.error("[Backup] Remove",n.backUpName,":",t.message),t})}function s(n){var r=this,a=[],o=[],u=[];return n.forEach(function(e){var t=e._deleted;t?u.push(e.id):o.push(l.call(r,e.id,e))}),u.length&&a.push({query:h.call(this,u.length),params:u}),o.length&&a.push({query:f.call(r,!0,o.length),params:o.reduce(function(e,t){return e.concat(t)},[])}),a.length?t.all(a.map(function(e){return r.execute(e.query,e.params)}))["catch"](function(t){throw e.error("[Backup] Bulk",r.backUpName,":",t.message),t}):t.when()}function p(e,n){var r=t.defer();return this.backUpDB().then(function(t){t.transaction(function(t){t.executeSql(e,n,function(e,t){r.resolve(t)},function(e,t){r.reject(t)})})}),r.promise}function h(e){var t="DELETE FROM "+this.backUpName+" WHERE id",n="",r=[],a=0;if(e=e||1,e>1){for(a=0;e>a;a++)r.push("?");n=" IN ("+r.join(",")+")"}else n="=?";return t+n}function f(e,t){function n(){var e=[];for(s=0;t>s;s++)e.push(0===s?"SELECT "+u.map(r).join(", "):"UNION ALL SELECT "+c);return e.join(" ")}function r(e){return"? as "+e}var a="INSERT "+(e?"OR REPLACE ":"")+"INTO",o="",u=this.helpers.fields,c=this.helpers.questionsMark,i="("+u.join(", ")+")",s=0;return t=t||1,o=t>1?n(u,c):o="VALUES ("+c+")",[a,this.backUpName,i,o].join(" ")}function l(e,t,n){var r=this.options.indexed_fields||[],a=r.map(function(e){var n=t[e];return"boolean"==typeof n?n?1:0:angular.isDefined(n)?n:null}),o=[angular.toJson(t)].concat(a);return o[n?"push":"unshift"](e),o}function m(e,t){return e.filter(function(e){return Object.keys(t||{}).every(function(n){var r=e[n],a=t[n];return angular.isArray(a)?a.some(function(e){return e===r}):a===r})})}function k(e){var t=[],n=0;for(n=0;n<e.rows.length;n++)t[n]=angular.fromJson(e.rows.item(n).payload);return t}return n.prototype.getBackUp=a,n.prototype.listBackUp=r,n.prototype.queryBackUp=o,n.prototype.saveBackUp=u,n.prototype.updateBackUp=c,n.prototype.removeBackUp=i,n.prototype.bulkDocsBackUp=s,n.prototype.execute=p,n}angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e),e.$inject=["$log","$q"]}();