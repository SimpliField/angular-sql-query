!function(){"use strict";function e(e,c){function o(e,n,r){function u(){return n()}var a,c,o;return this.options=r||{},a=this.options.indexed_fields||[],c=t(["id","payload"],a),o=c.map(function(){return"?"}).join(","),this.backUpName=e,this.helpers={fields:c,questionsMark:o},this.backUpDB=u,this}function i(){var t=this,n="SELECT * FROM "+t.backUpName;return this.execute(n).then(U)["catch"](function(n){throw e.error("[Backup] List",t.backUpName,":",n.message),n})}function s(t){var n=this,r="SELECT * FROM "+n.backUpName+" WHERE id=?";return this.execute(r,[t]).then(function(e){return e.rows.length?angular.fromJson(e.rows.item(0).payload):c.reject({message:"Not Found",status:404})})["catch"](function(t){throw e.error("[Backup] Get",n.backUpName,":",t.message),t})}function f(t){function o(e){var t=100;return Object.keys(e).reduce(function(n,r){var u=e[r];return angular.isArray(u)&&t<u.length?n.ext[r]=u:n.self[r]=u,n},{self:{},ext:{}})}function i(e,t){var n="tmp_"+e+"_";return Object.keys(t.ext||{}).map(function(e){var r=n+e;return[["DROP TABLE IF EXISTS "+r+"; "],["CREATE TABLE IF NOT EXISTS "+r+" (value TEXT); "]].concat(s(r,"value",t.ext[e]))})}function s(e,t,n){var r,u=500,a=n.length,c=Math.ceil(a/u),o=[];for(r=0;r<c;r++)o.push(n.slice(r*u,(r+1)*u-1));return o.map(function(n){var r="INSERT INTO "+e;return n.reduce(function(e,n,r){return 0===r?e[0]+=" SELECT ? as "+t:e[0]+=" UNION ALL SELECT ?",e[1].push(n),e},[r,[]])})}var f=this,p=f.options.indexed_fields||[],h=n(t),l=r(p,h),d=u(p,h),m=o(d);return c.all(i(f.backUpName,m).map(function(e){return f.batch(e)})).then(function(){var e=a(f.backUpName,m);return f.execute(e.request,e.data).then(function(e){var t=U(e);return b(t,l)})})["catch"](function(t){throw e.error("[Backup] Query",f.backUpName,":",t.message),t})}function p(t,n){var r=this,u=y.call(r,t,n),a=v.call(r,!0);return this.execute(a,u).then(function(){return n})["catch"](function(t){throw e.error("[Backup] Save",r.backUpName,":",t.message),t})}function h(t){var n=this,r=y.call(n,t.id,t,!0),u=n.helpers.fields.slice(1),a=u.map(function(e){return e+"=?"}).join(", "),c="UPDATE "+n.backUpName+" SET "+a+" WHERE id=?";return this.execute(c,r).then(function(){return t})["catch"](function(t){throw e.error("[Backup] Update",n.backUpName,":",t.message),t})}function l(t){var n=this,r=E.call(n);return this.execute(r,[t])["catch"](function(t){throw e.error("[Backup] Remove",n.backUpName,":",t.message),t})}function d(t){var n=this,r=[],u=[],a=[];return t.forEach(function(e){var t=e._deleted;t?a.push(e.id):u.push(y.call(n,e.id,e))}),a.length&&r.push({query:E.call(this,a.length),params:a}),u.length&&r.push({query:v.call(n,!0,u.length),params:u.reduce(function(e,t){return e.concat(t)},[])}),r.length?c.all(r.map(function(e){return n.execute(e.query,e.params)}))["catch"](function(t){throw e.error("[Backup] Bulk",n.backUpName,":",t.message),t}):c.when()}function m(e,t){var n=c.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,t,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})})}),n.promise}function k(t){function n(t,n){e.info(n)}function r(t,n){e.error(n)}var u=c.defer();return this.backUpDB().then(function(a){a.transaction(function(u){t.forEach(function(t){e.info("SQLite Bulk",t[0],t[1]),u.executeSql(t[0],t[1]||[],n,r)})},function(e){u.reject(e)},function(e){u.resolve(e)})}),u.promise}function E(e){var t="DELETE FROM "+this.backUpName+" WHERE id",n="",r=[],u=0;if(e=e||1,1<e){for(u=0;u<e;u++)r.push("?");n=" IN ("+r.join(",")+")"}else n="=?";return t+n}function v(e,t){function n(){var e=[];for(s=0;s<t;s++)e.push(0===s?"SELECT "+c.map(r).join(", "):"UNION ALL SELECT "+o);return e.join(" ")}function r(e){return"? as "+e}var u="INSERT "+(e?"OR REPLACE ":"")+"INTO",a="",c=this.helpers.fields,o=this.helpers.questionsMark,i="("+c.join(", ")+")",s=0;return t=t||1,a=1<t?n(c,o):a="VALUES ("+o+")",[u,this.backUpName,i,a].join(" ")}function y(e,t,n){var r=this.options.indexed_fields||[],u=r.map(function(e){var n=t[e];return"boolean"==typeof n?n?1:0:angular.isDefined(n)?n:null}),a=[angular.toJson(t)].concat(u);return a[n?"push":"unshift"](e),a}function b(e,t){return Object.keys(t).length?e.filter(function(e){return Object.keys(t||{}).every(function(n){var r=e[n],u=t[n];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function U(e){var t=[],n=0;for(n=0;n<e.rows.length;n++)t[n]=angular.fromJson(e.rows.item(n).payload);return t}return o.prototype.getBackUp=s,o.prototype.listBackUp=i,o.prototype.queryBackUp=f,o.prototype.saveBackUp=p,o.prototype.updateBackUp=h,o.prototype.removeBackUp=l,o.prototype.bulkDocsBackUp=d,o.prototype.execute=m,o.prototype.batch=k,o}function t(e,t){return(e||[]).concat(t||[]).reduce(function(e,t){return-1===e.indexOf(t)&&e.push(t),e},[])}function n(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return t[n]="boolean"==typeof r?r?1:0:r,t},{})}function r(e,t){return Object.keys(t).reduce(function(n,r){return-1===e.indexOf(r)&&"id"!==r&&(n[r]=t[r]),n},{})}function u(e,t){return Object.keys(t).reduce(function(n,r){return-1===e.indexOf(r)&&"id"!==r||(n[r]=t[r]),n},{})}function a(e,t){var n=Object.keys(t.self).reduce(function(e,n){var r=t[n];return e.data=e.data.concat(r),e.queryParts.push(n+(angular.isArray(r)?" IN ("+r.map(function(){return"?"}).join(",")+")":"=?")),e},{data:[],queryParts:[]});return n=Object.keys(t.ext).reduce(function(t,n){var r="tmp_"+e+"_"+n;return t.queryParts.push(n+" IN (SELECT value FROM "+r+")"),t},n),n.request="SELECT * FROM "+e+(n.queryParts.length?" WHERE ":"")+n.queryParts.join(" AND ")+";",n}e.$inject=["$log","$q"],angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();