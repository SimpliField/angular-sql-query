"use strict";!function(){function t(t,c){function i(t,n){function r(){return n()}var u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},c=u.indexed_fields||[],a=e(["id","payload"],c);return this.options=u,this.backUpName=t,this.helpers={fields:a},this.backUpDB=r,this}function l(){var e=this,n=o(e.backUpName);return this.execute(n).then(T).catch(function(n){throw t.error("[Backup] List",e.backUpName,":",n.message),n})}function k(e){var n=this,r=o(n.backUpName,["id"]);return this.execute(r,[e]).then(function(t){return t.rows.length?s(t,0):c.reject({message:"Not Found",status:404})}).catch(function(e){throw t.error("[Backup] Get",n.backUpName,":",e.message),e})}function y(e){function o(t,e,n){return d(n,v).map(function(n){return{query:"INSERT INTO "+t+" "+f(n,e),params:n}})}var i=this,s=i.options.indexed_fields||[],p=n(e||{}),l=u(s,p),h=function(t){return Object.keys(t).reduce(function(e,n){var r=t[n];return angular.isArray(r)&&m<r.length?e.ext[n]=r:e.self[n]=r,e},{self:{},ext:{}})}(l),k=function(t,e){var n="tmp_"+t+"_";return Object.keys(e.ext||{}).map(function(t){var r=n+t;return[{query:"DROP TABLE IF EXISTS "+r},{query:"CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)"}].concat(o(r,"value",e.ext[t]))})}(i.backUpName,h),y=k.map(function(t){return i.batch(t)}).reduce(function(t,e){return t.concat(e)},[]);return c.all(y).then(function(){var t=a(i.backUpName,h);return i.execute(t.request,t.data).then(function(t){return O(T(t),r(s,p))})}).catch(function(e){throw t.error("[Backup] Query",i.backUpName,":",e.message),e})}function E(e,n){var r=this,u=x.call(r,n),c=B.call(r,[n]);return this.execute(c,[n.id].concat(u)).then(function(){return n}).catch(function(e){throw t.error("[Backup] Save",r.backUpName,":",e.message),e})}function g(e){var n=this,r=x.call(n,e),u=n.helpers.fields.slice(1),c=u.map(function(t){return t+"=?"}).join(", "),a="UPDATE "+n.backUpName+" SET "+c+" WHERE id=?";return this.execute(a,r.concat([e.id])).then(function(){return e}).catch(function(e){throw t.error("[Backup] Update",n.backUpName,":",e.message),e})}function b(e){var n=this,r=q.call(n);return this.execute(r,[e]).catch(function(e){throw t.error("[Backup] Remove",n.backUpName,":",e.message),e})}function U(e){var n=this,r=[],u=e.filter(function(t){return t._deleted}).map(function(t){return t.id}),a=e.filter(function(t){return!t._deleted}).map(function(t){return[t.id].concat(x.call(n,t))});return u.length&&r.push({query:q.call(this,u),params:u}),a.length&&r.push({query:B.call(n,a),params:a.reduce(function(t,e){return t.concat(e)},[])}),r.length?c.all(r.map(function(t){return n.execute(t.query,t.params)})).catch(function(e){throw t.error("[Backup] Bulk",n.backUpName,":",e.message),e}):c.when()}function N(t,e){var n=c.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(t,e,function(t,e){n.resolve(e)},function(t,e){n.reject(e)})})}),n.promise}function j(e){function n(e,n){t.info(n)}function r(e,n){t.error(n)}var u=c.defer();return this.backUpDB().then(function(c){c.transaction(function(u){e.forEach(function(e){t.info("SQLite Bulk",e.query,e.params),u.executeSql(e.query,e.params||[],n,r)})},function(t){return u.reject(t)},function(t){return u.resolve(t)})}),u.promise}function q(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e="DELETE FROM "+this.backUpName+" WHERE id",n=p(t);return e+(1<t.length?" IN ("+n+")":"=?")}function B(t){var e=this.helpers.fields,n=p(e),r="("+e.join(", ")+")",u=1<t.length?f(t,e):"VALUES ("+n+")";return["INSERT OR REPLACE INTO",this.backUpName,r,u].join(" ")}function x(t){var e=this.options.indexed_fields||[],n=e.map(function(e){var n=t[e],r=h(n);return angular.isDefined(r)?r:null});return[angular.toJson(t)].concat(n)}function O(t,e){return Object.keys(e).length?t.filter(function(t){return Object.keys(e||{}).every(function(n){var r=t[n],u=e[n];return angular.isArray(u)?u.some(function(t){return t===r}):u===r})}):t}function T(t){var e=[],n=0;for(n=0;n<t.rows.length;n++)e[n]=s(t,n);return e}return i.prototype.getBackUp=k,i.prototype.listBackUp=l,i.prototype.queryBackUp=y,i.prototype.saveBackUp=E,i.prototype.updateBackUp=g,i.prototype.removeBackUp=b,i.prototype.bulkDocsBackUp=U,i.prototype.execute=N,i.prototype.batch=j,i}function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return t.concat(e).reduce(function(t,e){return-1===t.indexOf(e)?t.concat(e):t},[])}function n(t){return Object.keys(t).reduce(function(e,n){var r=t[n],u=h(r);return e[n]=u,e},{})}function r(t,e){return Object.keys(e).reduce(function(n,r){return c(r,t)||(n[r]=e[r]),n},{})}function u(t,e){return Object.keys(e).reduce(function(n,r){return c(r,t)&&(n[r]=e[r]),n},{})}function c(t,e){return-1!==e.indexOf(t)||"id"===t}function a(t,e){var n=Object.keys(e.self).reduce(function(t,n){var r=e.self[n];return t.data=t.data.concat(r),t.queryParts.push(n+(angular.isArray(r)?" IN ("+r.map(function(){return"?"}).join(",")+")":"=?")),t},{data:[],queryParts:[]});return n=Object.keys(e.ext).reduce(function(e,n){var r="tmp_"+t+"_"+n;return e.queryParts.push(n+" IN (SELECT value FROM "+r+")"),e},n),n.request=o(t)+(n.queryParts.length?" WHERE ":"")+n.queryParts.join(" AND ")+";",n}function o(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n="SELECT * FROM "+t,r=e.map(function(t){return t+"=?"}).join(" AND ");return r?n+" WHERE "+r:n}function i(t){return"SELECT "+[].concat(t).map(function(t){return"? as "+t}).join(", ")}function f(t,e){var n=[].concat(e),r=p(n),u=i(n);return t.map(function(t,e){return 0===e?u:"UNION ALL SELECT "+r}).join(" ")}function s(t,e){return angular.fromJson(t.rows.item(e).payload)}function p(t){return t.map(function(){return"?"}).join(",")}function l(t){return"boolean"==typeof t}function h(t){return l(t)?t?1:0:t}function d(t,e){for(var n=t.length,r=Math.ceil(n/e),u=[],c=0,a=0,o=0;c<r;c++)a=c*e,o=(c+1)*e,u.push(t.slice(a,o));return u}t.$inject=["$log","$q"];var m=100,v=500;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",t)}();