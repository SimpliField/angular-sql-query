"use strict";!function(){function e(e,o){function i(e,n){function r(){return n()}var u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=u.indexed_fields||[],c=t(["id","payload"],a),o=c.map(function(){return"?"}).join(",");return this.options=u,this.backUpName=e,this.helpers={fields:c,questionsMark:o},this.backUpDB=r,this}function s(){var t=this,n="SELECT * FROM "+t.backUpName;return this.execute(n).then(U).catch(function(n){throw e.error("[Backup] List",t.backUpName,":",n.message),n})}function f(t){var n=this,r="SELECT * FROM "+n.backUpName+" WHERE id=?";return this.execute(r,[t]).then(function(e){return e.rows.length?angular.fromJson(e.rows.item(0).payload):o.reject({message:"Not Found",status:404})}).catch(function(t){throw e.error("[Backup] Get",n.backUpName,":",t.message),t})}function p(t){function i(e,t,n){var r,u=n.length,a=Math.ceil(u/500),c=[];for(r=0;r<a;r++)c.push(n.slice(500*r,499*(r+1)));return c.map(function(n){var r="INSERT INTO "+e;return n.reduce(function(e,n,r){return e[0]+=0===r?" SELECT ? as "+t:" UNION ALL SELECT ?",e[1].push(n),e},[r,[]])})}var s=this,f=s.options.indexed_fields||[],p=n(t||{}),h=r(f,p),l=u(f,p),d=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return angular.isArray(r)&&c<r.length?t.ext[n]=r:t.self[n]=r,t},{self:{},ext:{}})}(l);return o.all(function(e,t){var n="tmp_"+e+"_";return Object.keys(t.ext||{}).map(function(e){var r=n+e;return[["DROP TABLE IF EXISTS "+r],["CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)"]].concat(i(r,"value",t.ext[e]))})}(s.backUpName,d).map(function(e){return s.batch(e)})).then(function(){var e=a(s.backUpName,d);return s.execute(e.request,e.data).then(function(e){return g(U(e),h)})}).catch(function(t){throw e.error("[Backup] Query",s.backUpName,":",t.message),t})}function h(t,n){var r=this,u=b.call(r,t,n),a=y.call(r,!0);return this.execute(a,u).then(function(){return n}).catch(function(t){throw e.error("[Backup] Save",r.backUpName,":",t.message),t})}function l(t){var n=this,r=b.call(n,t.id,t,!0),u=n.helpers.fields.slice(1),a=u.map(function(e){return e+"=?"}).join(", "),c="UPDATE "+n.backUpName+" SET "+a+" WHERE id=?";return this.execute(c,r).then(function(){return t}).catch(function(t){throw e.error("[Backup] Update",n.backUpName,":",t.message),t})}function d(t){var n=this,r=v.call(n);return this.execute(r,[t]).catch(function(t){throw e.error("[Backup] Remove",n.backUpName,":",t.message),t})}function m(t){var n=this,r=[],u=[],a=[];return t.forEach(function(e){e._deleted?a.push(e.id):u.push(b.call(n,e.id,e))}),a.length&&r.push({query:v.call(this,a.length),params:a}),u.length&&r.push({query:y.call(n,!0,u.length),params:u.reduce(function(e,t){return e.concat(t)},[])}),r.length?o.all(r.map(function(e){return n.execute(e.query,e.params)})).catch(function(t){throw e.error("[Backup] Bulk",n.backUpName,":",t.message),t}):o.when()}function k(e,t){var n=o.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,t,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})})}),n.promise}function E(t){function n(t,n){e.info(n)}function r(t,n){e.error(n)}var u=o.defer();return this.backUpDB().then(function(a){a.transaction(function(u){t.forEach(function(t){e.info("SQLite Bulk",t[0],t[1]),u.executeSql(t[0],t[1]||[],n,r)})},function(e){return u.reject(e)},function(e){return u.resolve(e)})}),u.promise}function v(e){var t="DELETE FROM "+this.backUpName+" WHERE id",n="",r=[],u=0;if(1<(e=e||1)){for(u=0;u<e;u++)r.push("?");n=" IN ("+r.join(",")+")"}else n="=?";return t+n}function y(e,t){function n(e){return"? as "+e}var r="INSERT "+(e?"OR REPLACE ":"")+"INTO",u="",a=this.helpers.fields,c=this.helpers.questionsMark,o="("+a.join(", ")+")",i=0;return t=t||1,u=1<t?function(){var e=[];for(i=0;i<t;i++)e.push(0===i?"SELECT "+a.map(n).join(", "):"UNION ALL SELECT "+c);return e.join(" ")}():u="VALUES ("+c+")",[r,this.backUpName,o,u].join(" ")}function b(e,t,n){var r=this.options.indexed_fields||[],u=r.map(function(e){var n=t[e];return"boolean"==typeof n?n?1:0:angular.isDefined(n)?n:null}),a=[angular.toJson(t)].concat(u);return a[n?"push":"unshift"](e),a}function g(e,t){return Object.keys(t).length?e.filter(function(e){return Object.keys(t||{}).every(function(n){var r=e[n],u=t[n];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function U(e){var t=[],n=0;for(n=0;n<e.rows.length;n++)t[n]=angular.fromJson(e.rows.item(n).payload);return t}return i.prototype.getBackUp=f,i.prototype.listBackUp=s,i.prototype.queryBackUp=p,i.prototype.saveBackUp=h,i.prototype.updateBackUp=l,i.prototype.removeBackUp=d,i.prototype.bulkDocsBackUp=m,i.prototype.execute=k,i.prototype.batch=E,i}function t(e,t){return(e||[]).concat(t||[]).reduce(function(e,t){return-1===e.indexOf(t)&&e.push(t),e},[])}function n(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return t[n]="boolean"==typeof r?r?1:0:r,t},{})}function r(e,t){return Object.keys(t).reduce(function(n,r){return-1===e.indexOf(r)&&"id"!==r&&(n[r]=t[r]),n},{})}function u(e,t){return Object.keys(t).reduce(function(n,r){return-1===e.indexOf(r)&&"id"!==r||(n[r]=t[r]),n},{})}function a(e,t){var n=Object.keys(t.self).reduce(function(e,n){var r=t.self[n];return e.data=e.data.concat(r),e.queryParts.push(n+(angular.isArray(r)?" IN ("+r.map(function(){return"?"}).join(",")+")":"=?")),e},{data:[],queryParts:[]});return n=Object.keys(t.ext).reduce(function(t,n){var r="tmp_"+e+"_"+n;return t.queryParts.push(n+" IN (SELECT value FROM "+r+")"),t},n),n.request="SELECT * FROM "+e+(n.queryParts.length?" WHERE ":"")+n.queryParts.join(" AND ")+";",n}e.$inject=["$log","$q"];var c=100;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();