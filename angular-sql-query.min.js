"use strict";!function(){function e(e,c){function f(e,n){function r(){return n()}var u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},c=u.indexed_fields||[],a=t(["id","payload"],c),o=a.map(function(){return"?"}).join(",");return this.options=u,this.backUpName=e,this.helpers={fields:a,questionsMark:o},this.backUpDB=r,this}function m(){var t=this,n=o(t.backUpName);return this.execute(n).then(T).catch(function(n){throw console.log(n),e.error("[Backup] List",t.backUpName,":",n.message),n})}function v(t){var n=this,r=o(n.backUpName,["id"]);return this.execute(r,[t]).then(function(e){return e.rows.length?i(e,0):c.reject({message:"Not Found",status:404})}).catch(function(t){throw e.error("[Backup] Get",n.backUpName,":",t.message),t})}function k(t){function o(e,t,n){return l(n,d).map(function(n){var r="INSERT INTO "+e;return n.reduce(function(e,n,r){return e.query+=0===r?" SELECT ? as "+t:" UNION ALL SELECT ?",e.params=e.params.concat(n),e},{query:r,params:[]})})}var i=this,s=i.options.indexed_fields||[],f=n(t||{}),p=u(s,f),m=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return angular.isArray(r)&&h<r.length?t.ext[n]=r:t.self[n]=r,t},{self:{},ext:{}})}(p),v=function(e,t){var n="tmp_"+e+"_";return Object.keys(t.ext||{}).map(function(e){var r=n+e;return[{query:"DROP TABLE IF EXISTS "+r},{query:"CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)"}].concat(o(r,"value",t.ext[e]))})}(i.backUpName,m),k=v.map(function(e){return i.batch(e)}).reduce(function(e,t){return e.concat(t)},[]);return c.all(k).then(function(){var e=a(i.backUpName,m);return i.execute(e.request,e.data).then(function(e){return O(T(e),r(s,f))})}).catch(function(t){throw e.error("[Backup] Query",i.backUpName,":",t.message),t})}function y(t,n){var r=this,u=B.call(r,t,n),c=j.call(r,!0);return this.execute(c,u).then(function(){return n}).catch(function(t){throw e.error("[Backup] Save",r.backUpName,":",t.message),t})}function E(t){var n=this,r=B.call(n,t.id,t,!0),u=n.helpers.fields.slice(1),c=u.map(function(e){return e+"=?"}).join(", "),a="UPDATE "+n.backUpName+" SET "+c+" WHERE id=?";return this.execute(a,r).then(function(){return t}).catch(function(t){throw e.error("[Backup] Update",n.backUpName,":",t.message),t})}function g(t){var n=this,r=q.call(n);return this.execute(r,[t]).catch(function(t){throw e.error("[Backup] Remove",n.backUpName,":",t.message),t})}function b(t){var n=this,r=[],u=t.filter(function(e){return!e._deleted}).map(function(e){return B.call(n,e.id,e)}),a=t.filter(function(e){return e._deleted}).map(function(e){return e.id});return a.length&&r.push({query:q.call(this,a.length),params:a}),u.length&&r.push({query:j.call(n,!0,u.length),params:u.reduce(function(e,t){return e.concat(t)},[])}),r.length?c.all(r.map(function(e){return n.execute(e.query,e.params)})).catch(function(t){throw e.error("[Backup] Bulk",n.backUpName,":",t.message),t}):c.when()}function N(e,t){var n=c.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,t,function(e,t){n.resolve(t)},function(e,t){n.reject(t)})})}),n.promise}function U(t){function n(t,n){e.info(n)}function r(t,n){e.error(n)}var u=c.defer();return this.backUpDB().then(function(c){c.transaction(function(u){t.forEach(function(t){e.info("SQLite Bulk",t.query,t.params),u.executeSql(t.query,t.params||[],n,r)})},function(e){return u.reject(e)},function(e){return u.resolve(e)})}),u.promise}function q(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t="DELETE FROM "+this.backUpName+" WHERE id",n=1<e,r=n?s(e):[];return t+(n?" IN ("+r.join(",")+")":"=?")}function j(e,t){function n(e){return"? as "+e}var r="INSERT "+(e?"OR REPLACE ":"")+"INTO",u="",c=this.helpers.fields,a=this.helpers.questionsMark,o="("+c.join(", ")+")",i=0;return t=t||1,u=1<t?function(){var e=[];for(i=0;i<t;i++)e.push(0===i?"SELECT "+c.map(n).join(", "):"UNION ALL SELECT "+a);return e.join(" ")}():u="VALUES ("+a+")",[r,this.backUpName,o,u].join(" ")}function B(e,t,n){var r=this.options.indexed_fields||[],u=r.map(function(e){var n=t[e],r=p(n);return angular.isDefined(r)?r:null}),c=[angular.toJson(t)].concat(u);return c[n?"push":"unshift"](e),c}function O(e,t){return Object.keys(t).length?e.filter(function(e){return Object.keys(t||{}).every(function(n){var r=e[n],u=t[n];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function T(e){var t=[],n=0;for(n=0;n<e.rows.length;n++)t[n]=i(e,n);return t}return f.prototype.getBackUp=v,f.prototype.listBackUp=m,f.prototype.queryBackUp=k,f.prototype.saveBackUp=y,f.prototype.updateBackUp=E,f.prototype.removeBackUp=g,f.prototype.bulkDocsBackUp=b,f.prototype.execute=N,f.prototype.batch=U,f}function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.concat(t).reduce(function(e,t){return-1===e.indexOf(t)?e.concat(t):e},[])}function n(e){return Object.keys(e).reduce(function(t,n){var r=e[n],u=p(r);return t[n]=u,t},{})}function r(e,t){return Object.keys(t).reduce(function(n,r){return c(r,e)||(n[r]=t[r]),n},{})}function u(e,t){return Object.keys(t).reduce(function(n,r){return c(r,e)&&(n[r]=t[r]),n},{})}function c(e,t){return-1!==t.indexOf(e)||"id"===e}function a(e,t){var n=Object.keys(t.self).reduce(function(e,n){var r=t.self[n];return e.data=e.data.concat(r),e.queryParts.push(n+(angular.isArray(r)?" IN ("+r.map(function(){return"?"}).join(",")+")":"=?")),e},{data:[],queryParts:[]});return n=Object.keys(t.ext).reduce(function(t,n){var r="tmp_"+e+"_"+n;return t.queryParts.push(n+" IN (SELECT value FROM "+r+")"),t},n),n.request=o(e)+(n.queryParts.length?" WHERE ":"")+n.queryParts.join(" AND ")+";",n}function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n="SELECT * FROM "+e,r=t.map(function(e){return e+"=?"}).join(" AND ");return r?n+" WHERE "+r:n}function i(e,t){return angular.fromJson(e.rows.item(t).payload)}function s(e){for(var t=0,n=[];t<e;t++)n=n.concat("?");return n}function f(e){return"boolean"==typeof e}function p(e){return f(e)?e?1:0:e}function l(e,t){for(var n=e.length,r=Math.ceil(n/t),u=[],c=0,a=0,o=0;c<r;c++)a=c*t,o=(c+1)*t,u.push(e.slice(a,o));return u}e.$inject=["$log","$q"];var h=100,d=500;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();