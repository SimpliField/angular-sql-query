"use strict";!function(){function e(e,r){function a(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=t.indexed_fields||[];return this.options=t,this.backUpName=e,this.helpers={indexed_fields:r},this.backUpDB=function(){return n()},this}return a.prototype.getBackUp=function(n){var u=this,c=t(u.backUpName,{id:n});return this.execute(c.query,c.params).then(function(e){return e.rows.length?v(e,0):r.reject({message:"Not Found",status:404})}).catch(function(n){throw e.error("[Backup] Get",u.backUpName,":",n.message),n})},a.prototype.listBackUp=function(n){var r=this,u=t(r.backUpName,{},n);return this.execute(u.query).then(h).catch(function(n){throw e.error("[Backup] List",r.backUpName,":",n.message),n})},a.prototype.queryBackUp=function(t,u){function a(e,n,t){return g(t,N).map(function(t){return{query:"INSERT INTO "+e+" "+c(t,n),params:t}})}var o=this,i=o.helpers.indexed_fields,f=l(t||{}),s=function(e){return Object.keys(e).reduce(function(n,t){var r=e[t];return angular.isArray(r)&&U<r.length?n.ext[t]=r:n.self[t]=r,n},{self:{},ext:{}})}(d(i,f)),y=function(e,n){var t="tmp_"+o.backUpName+"_";return Object.keys(n.ext||{}).map(function(e){var r=t+e,u="DROP TABLE IF EXISTS "+r,c="CREATE TABLE IF NOT EXISTS "+r+" (value TEXT)",o=a(r,"value",n.ext[e]);return[{query:u},{query:c}].concat(o)})}(0,s).reduce(function(e,n){return e.concat(n)},[]);return(y.length?o.batch(y):r.when()).then(function(){var e=n(o.backUpName,s,u);return o.execute(e.query,e.params).then(function(e){return p(h(e),m(i,f))})}).catch(function(n){throw e.error("[Backup] Query",o.backUpName,":",n.message),n})},a.prototype.saveBackUp=function(n,t){var r=this,c=r.helpers.indexed_fields,a=this.backUpName,o=u([t],c,a);return this.execute(o.query,o.params).then(function(){return t}).catch(function(n){throw e.error("[Backup] Save",r.backUpName,":",n.message),n})},a.prototype.updateBackUp=function(n){var t=this,r=t.backUpName,u=t.helpers.indexed_fields,c=o(n,u,r);return this.execute(c.query,c.params).then(function(){return n}).catch(function(n){throw e.error("[Backup] Update",r,":",n.message),n})},a.prototype.removeBackUp=function(n){var t=this,r=i([n],t.backUpName);return this.execute(r.query,r.params).catch(function(n){throw e.error("[Backup] Remove",t.backUpName,":",n.message),n})},a.prototype.bulkDocsBackUp=function(n){var t=this,c=t.helpers.indexed_fields,a=t.backUpName,o=[],f=n.filter(function(e){return e._deleted}).map(function(e){return e.id}),s=n.filter(function(e){return!e._deleted});return f.length&&o.push(i(f,a)),s.length&&o.push(u(s,c,a)),o.length?r.all(o.map(function(e){return t.execute(e.query,e.params)})).catch(function(n){throw e.error("[Backup] Bulk",t.backUpName,":",n.message),n}):r.when()},a.prototype.execute=function(e,n){var t=r.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,n,function(e,n){t.resolve(n)},function(e,n){t.reject(n)})})}),t.promise},a.prototype.batch=function(e){function n(n){var t=r.defer();return n.transaction(function(n){e.forEach(function(e){n.executeSql(e.query,e.params||[])})},t.reject,t.resolve),t.promise}var t=r.defer();return this.backUpDB().then(function(r){return r.sqlBatch?r.sqlBatch(e.map(function(e){return[e.query,e.params||[]]}),function(e){return t.resolve(e)},function(e){return t.reject(e)}):n(r).then(t.resolve).catch(t.reject)}),t.promise},a}function n(e,n,t){function u(e){return Object.keys(e).map(function(e){var t=n.self[e];return e+(angular.isArray(t)?" IN ("+k(t)+")":"=?")})}function c(n){return Object.keys(n).map(function(n){return n+" IN (SELECT value FROM "+("tmp_"+e+"_"+n)+")"})}return{query:function(n){var a="SELECT * FROM "+e,o=[].concat(u(n.self),c(n.ext));return r(a+(o.length?" WHERE ":"")+o.join(" AND "),t)+";"}(n),params:Object.keys(n.self).reduce(function(e,t){return e.concat(n.self[t])},[])}}function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},u="SELECT * FROM "+e,c=Object.keys(n),a=c.map(function(e){return e+"=?"}).join(" AND "),o=c.map(function(e){return n[e]});return{query:r(a?u+" WHERE "+a:u,t),params:o}}function r(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=n.limit?" LIMIT "+n.limit:"";return n.offset&&(t+=" OFFSET "+n.offset),e+t}function u(e,n,t){var r="INSERT OR REPLACE INTO "+t,u=["id","payload"].concat(n),a=k(u);return{query:r+" "+("("+u.join(", ")+")")+" "+(1<e.length?c(e,u):"VALUES ("+a+")"),params:e.map(function(e){return[e.id].concat(f(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function c(e,n){var t=[].concat(n),r=k(t),u=a(t);return e.map(function(e,n){return 0===n?u:"UNION ALL SELECT "+r}).join(" ")}function a(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function o(e,n,t){var r="UPDATE "+t,u=["payload"].concat(n),c=f(e,n);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function i(e,n){var t="DELETE FROM "+n+" WHERE id",r=k(e);return{query:""+t+(1<e.length?" IN ("+r+")":"=?"),params:e}}function f(e,n){var t=s(e,n);return[angular.toJson(e)].concat(t)}function s(e,n){return n.map(function(n){var t=E(e[n]);return angular.isDefined(t)?t:null})}function p(e,n){return Object.keys(n).length?e.filter(function(e){return Object.keys(n||{}).every(function(t){var r=e[t],u=n[t];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function h(e){var n=[],t=0;for(t=0;t<e.rows.length;t++)n[t]=v(e,t);return n}function l(e){return Object.keys(e).reduce(function(n,t){var r=E(e[t]);return n[t]=r,n},{})}function m(e,n){return Object.keys(n).reduce(function(t,r){return y(r,e)||(t[r]=n[r]),t},{})}function d(e,n){return Object.keys(n).reduce(function(t,r){return y(r,e)&&(t[r]=n[r]),t},{})}function y(e,n){return-1!==n.indexOf(e)||"id"===e}function v(e,n){return angular.fromJson(e.rows.item(n).payload)}function k(e){return e.map(function(){return"?"}).join(",")}function E(e){return b(e)?e?1:0:e}function b(e){return"boolean"==typeof e}function g(e,n){for(var t=e.length,r=Math.ceil(t/n),u=[],c=0,a=0,o=0;c<r;c++)a=c*n,o=(c+1)*n,u.push(e.slice(a,o));return u}e.$inject=["$log","$q"];var U=100,N=300;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();