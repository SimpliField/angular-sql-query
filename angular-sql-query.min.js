"use strict";!function(){function e(e,c){function i(e,n){function t(){return n()}var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},u=r.indexed_fields||[];return this.options=r,this.backUpName=e,this.helpers={indexed_fields:u},this.backUpDB=t,this}function f(){var n=this,r=t(n.backUpName);return this.execute(r.query).then(p).catch(function(t){throw e.error("[Backup] List",n.backUpName,":",t.message),t})}function d(n){var r=this,u=t(r.backUpName,{id:n});return this.execute(u.query,u.params).then(function(e){return e.rows.length?y(e,0):c.reject({message:"Not Found",status:404})}).catch(function(n){throw e.error("[Backup] Get",r.backUpName,":",n.message),n})}function k(t){function r(e,n,t){return b(t,U).map(function(t){return{query:"INSERT INTO "+e+" "+u(t,n),params:t}})}var a=this,o=a.helpers.indexed_fields,i=l(t||{}),f=m(o,i),d=function(e){return Object.keys(e).reduce(function(n,t){var r=e[t];return angular.isArray(r)&&g<r.length?n.ext[t]=r:n.self[t]=r,n},{self:{},ext:{}})}(f),y=function(e,n){var t="tmp_"+e+"_";return Object.keys(n.ext||{}).map(function(e){var u=t+e;return[{query:"DROP TABLE IF EXISTS "+u},{query:"CREATE TABLE IF NOT EXISTS "+u+" (value TEXT)"}].concat(r(u,"value",n.ext[e]))})}(a.backUpName,d),k=y.map(function(e){return a.batch(e)}).reduce(function(e,n){return e.concat(n)},[]);return c.all(k).then(function(){var e=n(a.backUpName,d);return a.execute(e.query,e.params).then(function(e){return s(p(e),h(o,i))})}).catch(function(n){throw e.error("[Backup] Query",a.backUpName,":",n.message),n})}function v(n,t){var u=this,c=u.helpers.indexed_fields,a=this.backUpName,o=r([t],c,a);return this.execute(o.query,o.params).then(function(){return t}).catch(function(n){throw e.error("[Backup] Save",u.backUpName,":",n.message),n})}function E(n){var t=this,r=t.backUpName,u=t.helpers.indexed_fields,c=a(n,u,r);return this.execute(c.query,c.params).then(function(){return n}).catch(function(n){throw e.error("[Backup] Update",r,":",n.message),n})}function N(n){var t=this,r=o([n],t.backUpName);return this.execute(r.query,r.params).catch(function(n){throw e.error("[Backup] Remove",t.backUpName,":",n.message),n})}function q(n){var t=this,u=t.helpers.indexed_fields,a=t.backUpName,i=[],f=n.filter(function(e){return e._deleted}).map(function(e){return e.id}),s=n.filter(function(e){return!e._deleted});return f.length&&i.push(o(f,a)),s.length&&i.push(r(s,u,a)),i.length?c.all(i.map(function(e){return t.execute(e.query,e.params)})).catch(function(n){throw e.error("[Backup] Bulk",t.backUpName,":",n.message),n}):c.when()}function j(e,n){var t=c.defer();return this.backUpDB().then(function(r){r.transaction(function(r){r.executeSql(e,n,function(e,n){t.resolve(n)},function(e,n){t.reject(n)})})}),t.promise}function x(n){function t(n,t){e.info(t)}function r(n,t){e.error(t)}var u=c.defer();return this.backUpDB().then(function(c){c.transaction(function(u){n.forEach(function(n){e.info("SQLite Bulk",n.query,n.params),u.executeSql(n.query,n.params||[],t,r)})},function(e){return u.reject(e)},function(e){return u.resolve(e)})}),u.promise}return i.prototype.getBackUp=d,i.prototype.listBackUp=f,i.prototype.queryBackUp=k,i.prototype.saveBackUp=v,i.prototype.updateBackUp=E,i.prototype.removeBackUp=N,i.prototype.bulkDocsBackUp=q,i.prototype.execute=j,i.prototype.batch=x,i}function n(e,n){function t(e){return Object.keys(e).map(function(e){var t=n.self[e];return e+(angular.isArray(t)?" IN ("+k(t)+")":"=?")})}function r(n){return Object.keys(n).map(function(n){return n+" IN (SELECT value FROM tmp_"+e+"_"+n+")"})}return{query:function(n){var u="SELECT * FROM "+e,c=[].concat(t(n.self),r(n.ext));return u+(c.length?" WHERE ":"")+c.join(" AND ")+";"}(n),params:Object.keys(n.self).reduce(function(e,t){return e.concat(n.self[t])},[])}}function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t="SELECT * FROM "+e,r=Object.keys(n),u=r.map(function(e){return e+"=?"}).join(" AND "),c=r.map(function(e){return n[e]});return{query:u?t+" WHERE "+u:t,params:c}}function r(e,n,t){var r="INSERT OR REPLACE INTO "+t,c=["id","payload"].concat(n),a=k(c);return{query:r+" ("+c.join(", ")+") "+(1<e.length?u(e,c):"VALUES ("+a+")"),params:e.map(function(e){return[e.id].concat(i(e,n))}).reduce(function(e,n){return e.concat(n)},[])}}function u(e,n){var t=[].concat(n),r=k(t),u=c(t);return e.map(function(e,n){return 0===n?u:"UNION ALL SELECT "+r}).join(" ")}function c(e){return"SELECT "+e.map(function(e){return"? as "+e}).join(", ")}function a(e,n,t){var r="UPDATE "+t,u=["payload"].concat(n),c=i(e,n);return{query:r+" SET "+u.map(function(e){return e+"=?"}).join(", ")+" WHERE id=?",params:c.concat([e.id])}}function o(e,n){var t="DELETE FROM "+n+" WHERE id",r=k(e);return{query:t+(1<e.length?" IN ("+r+")":"=?"),params:e}}function i(e,n){var t=f(e,n);return[angular.toJson(e)].concat(t)}function f(e,n){return n.map(function(n){var t=e[n],r=v(t);return angular.isDefined(r)?r:null})}function s(e,n){return Object.keys(n).length?e.filter(function(e){return Object.keys(n||{}).every(function(t){var r=e[t],u=n[t];return angular.isArray(u)?u.some(function(e){return e===r}):u===r})}):e}function p(e){var n=[],t=0;for(t=0;t<e.rows.length;t++)n[t]=y(e,t);return n}function l(e){return Object.keys(e).reduce(function(n,t){var r=e[t],u=v(r);return n[t]=u,n},{})}function h(e,n){return Object.keys(n).reduce(function(t,r){return d(r,e)||(t[r]=n[r]),t},{})}function m(e,n){return Object.keys(n).reduce(function(t,r){return d(r,e)&&(t[r]=n[r]),t},{})}function d(e,n){return-1!==n.indexOf(e)||"id"===e}function y(e,n){return angular.fromJson(e.rows.item(n).payload)}function k(e){return e.map(function(){return"?"}).join(",")}function v(e){return E(e)?e?1:0:e}function E(e){return"boolean"==typeof e}function b(e,n){for(var t=e.length,r=Math.ceil(t/n),u=[],c=0,a=0,o=0;c<r;c++)a=c*n,o=(c+1)*n,u.push(e.slice(a,o));return u}e.$inject=["$log","$q"];var g=100,U=500;angular.module("sf.sqlQuery",[]).factory("SqlQueryService",e)}();